#
# Serial Studio
# https://serial-studio.com/
#
# Copyright (C) 2020â€“2025 Alex Spataru
#
# This file is dual-licensed:
#
# - Under the GNU GPLv3 (or later) for builds that exclude Pro modules.
# - Under the Serial Studio Commercial License for builds that include
#   any Pro functionality.
#
# You must comply with the terms of one of these licenses, depending
# on your use case.
#
# For GPL terms, see <https://www.gnu.org/licenses/gpl-3.0.html>
# For commercial terms, see LICENSE_COMMERCIAL.md in the project root.
#
# SPDX-License-Identifier: GPL-3.0-only OR LicenseRef-SerialStudio-Commercial
#

#-------------------------------------------------------------------------------
# Workflow configuration
#-------------------------------------------------------------------------------

name: Deploy

on:
  push:               # Run on push
    paths-ignore:     # File patterns to ignore
    - '**.md'         # Ignore changes to *.md files

  pull_request:       # Run on pull-request
    paths-ignore:     # File-patterns to ignore
    - '**.md'         # Ignore changes to *.md files

#-------------------------------------------------------------------------------
# Define application name & version
#-------------------------------------------------------------------------------

env:
  VERSION: "3.1.7"
  QT_VERSION_LINUX: 6.9.1
  QT_VERSION_MACOS: 6.9.1
  QT_VERSION_WINDOWS: 6.9.1
  EXECUTABLE: "Serial-Studio"
  APPLICATION: "Serial Studio"
  UNIXNAME: "serial-studio"
  QML_DIR: "../../app/qml"
  PUBLISHER: "Alex Spataru"
  INSTALL_QT_MACOS: false
  INSTALL_QT_WINDOWS: false
  INSTALL_QT_LINUX: true
  QTFRAMEWORK_BYPASS_LICENSE_CHECK: "true"
  DESCRIPTION: "Multi-purpose serial data visualization & processing program"

#-------------------------------------------------------------------------------
# Begin workflow jobs definition
#-------------------------------------------------------------------------------

jobs:

#-------------------------------------------------------------------------------
# GNU/Linux build (x86_64 and arm64)
#-------------------------------------------------------------------------------

  - build-linux:
    strategy:
      matrix:
        include:
          - edition: commercial
            arch: x64
            runs-on: ubuntu-22.04
          - edition: gpl3
            arch: x64
            runs-on: ubuntu-22.04
          - edition: commercial
            arch: arm64
            runs-on: ubuntu-24.04-arm
          - edition: gpl3
            arch: arm64
            runs-on: ubuntu-22.04-arm
    name: "ðŸ§ Linux (${{ matrix.arch }}) - ${{ matrix.edition == 'commercial' && 'Pro' || 'GPL3' }}"
    steps:
      - name: "ðŸ§° Checkout"
        uses: actions/checkout@v4

      - name: "âš™ï¸ Install dependencies"
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            fakeroot \
            libcups2-dev \
            libegl1 \
            libfuse2 \
            libgl1-mesa-dev \
            libasound2-dev \
            libssl-dev \
            libudev-dev \
            libzstd-dev \
            rpm \
            libxcb1 \
            libxcb-cursor0 \
            libxcb-cursor-dev \
            libxcb-glx0 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-image0-dev \
            libxcb-keysyms1 \
            libxcb-randr0 \
            libxcb-render0 \
            libxcb-render-util0 \
            libxcb-shape0 \
            libxcb-shm0 \
            libxcb-sync1 \
            libxcb-util0-dev \
            libxcb-util1 \
            libxcb-xfixes0 \
            libxcb-xinerama0 \
            libxcb-xkb-dev \
            libxcb-xtest0 \
            libxkbcommon-dev \
            libxkbcommon-x11-0 \
            libxkbcommon-x11-dev

      - name: "âš™ï¸ Install CMake"
        uses: lukka/get-cmake@latest
        with:
          useLocalCache: true

      #---------------------------------------------------------------------------
      # Qt installation for commercial builds
      #---------------------------------------------------------------------------

      - name: "âš™ï¸ Restore Commercial Qt Cache"
        uses: actions/cache/restore@v3
        if: matrix.edition == 'commercial' && env.INSTALL_QT_LINUX == 'false'
        with:
          path: |
            ${{github.workspace}}/Qt-${{env.QT_VERSION_LINUX}}-${{runner.os}}-${{matrix.arch}}
            ${{env.USERPROFILE}}/.qt-license
          key: qt-${{runner.os}}-${{env.QT_VERSION_LINUX}}-${{matrix.arch}}

      - name: "âš™ï¸ Install Commercial Qt"
        if: matrix.edition == 'commercial' && env.INSTALL_QT_LINUX == 'true'
        shell: bash
        env:
          QT_VERSION: ${{env.QT_VERSION_LINUX}}
          QT_ARCH: ${{matrix.arch}}
          QT_USERNAME: ${{secrets.QT_USERNAME}}
          QT_PASSWORD: ${{secrets.QT_PASSWORD}}
          QT_OUTPUT_DIR: ${{github.workspace}}/Qt-${{env.QT_VERSION_LINUX}}-${{runner.os}}-${{matrix.arch}}
        run: |
          chmod +x ./scripts/install-qt.sh
          ./scripts/install-qt.sh

      - name: "âš™ï¸ Save Commercial Qt Cache"
        if: matrix.edition == 'commercial' && env.INSTALL_QT_LINUX == 'true'
        uses: actions/cache/save@v3
        with:
          path: |
            ${{github.workspace}}/Qt-${{env.QT_VERSION_LINUX}}-${{runner.os}}-${{matrix.arch}}
            ${{env.USERPROFILE}}/.qt-license
          key: qt-${{runner.os}}-${{env.QT_VERSION_LINUX}}-${{matrix.arch}}

      - name: "âš™ï¸ Add Qt to PATH"
        if: matrix.edition == 'commercial'
        shell: bash
        env:
          QT_VERSION: ${{env.QT_VERSION_LINUX}}
          QT_OUTPUT_DIR: ${{github.workspace}}/Qt-${{env.QT_VERSION_LINUX}}-${{runner.os}}-${{matrix.arch}}
        run: |
          if [ "${{matrix.arch}}" = "x64" ]; then
            export QT_BIN_PATH="${QT_OUTPUT_DIR}/${QT_VERSION}/gcc_64/bin"
            export QT_LIBEXEC_PATH="${QT_OUTPUT_DIR}/${QT_VERSION}/gcc_64/libexec"
            export CMAKE_PREFIX_PATH="${QT_OUTPUT_DIR}/${QT_VERSION}/gcc_64/lib/cmake"
          else
            export QT_BIN_PATH="${QT_OUTPUT_DIR}/${QT_VERSION}/gcc_arm64/bin"
            export QT_LIBEXEC_PATH="${QT_OUTPUT_DIR}/${QT_VERSION}/gcc_arm64/libexec"
            export CMAKE_PREFIX_PATH="${QT_OUTPUT_DIR}/${QT_VERSION}/gcc_arm64/lib/cmake"
          fi
          echo "$QT_BIN_PATH" >> $GITHUB_PATH
          echo "$QT_LIBEXEC_PATH" >> $GITHUB_PATH
          echo "CMAKE_PREFIX_PATH=$CMAKE_PREFIX_PATH" >> $GITHUB_ENV

      #---------------------------------------------------------------------------
      # Qt installation for GPLv3 builds
      #---------------------------------------------------------------------------

      - name: "âš™ï¸ Install Open Source Qt"
        if: matrix.edition == 'gpl3'
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{env.QT_VERSION_LINUX}}
          target: desktop
          host: ${{ matrix.arch == 'x64' && 'linux' || 'linux_arm64' }}
          arch: ${{ matrix.arch == 'x64' && 'linux_gcc_64' || 'linux_gcc_arm64' }}
          modules: qt3d qtquick3d qtdatavis3d qtgraphs qtserialport qtconnectivity qtshadertools
          cache: true

      #---------------------------------------------------------------------------
      # Configure and build
      #---------------------------------------------------------------------------

      - name: "ðŸš§ Configure with CMake (Commercial)"
        if: matrix.edition == 'commercial'
        env:
          ARCGIS_API_KEY: ${{ secrets.ARCGIS_API_KEY }}
          SERIAL_STUDIO_LICENSE_KEY: ${{ secrets.SERIAL_STUDIO_LICENSE_KEY }}
          SERIAL_STUDIO_INSTANCE_ID: ${{ secrets.SERIAL_STUDIO_INSTANCE_ID }}
        run: |
          mkdir build
          cd build
          cmake ../ -DPRODUCTION_OPTIMIZATION=ON -DCMAKE_BUILD_TYPE=Release -DBUILD_COMMERCIAL=ON -DBUILD_GPL3=OFF

      - name: "ðŸš§ Configure with CMake (GPLv3)"
        if: matrix.edition == 'gpl3'
        run: |
          mkdir build
          cd build
          cmake ../ -DPRODUCTION_OPTIMIZATION=ON -DCMAKE_BUILD_TYPE=Release

      - name: "ðŸš§ Build application"
        run: |
          cd build
          cmake --build . --config Release --parallel 16

      #---------------------------------------------------------------------------
      # AppImage creation
      #---------------------------------------------------------------------------

      - name: "ðŸ“¦ Create AppImage"
        env:
          APPIMAGE_NAME: ${{env.EXECUTABLE}}-${{ matrix.edition == 'commercial' && 'Pro' || 'GPL3' }}-${{env.VERSION}}-Linux-${{matrix.arch}}.AppImage
        run: |
          cd "build/app"
          if [ "${{matrix.arch}}" = "x64" ]; then
            wget https://github.com/linuxdeploy/linuxdeploy/releases/download/1-alpha-20240109-1/linuxdeploy-x86_64.AppImage
            wget https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
            chmod +x linuxdeploy-x86_64.AppImage
            chmod +x linuxdeploy-plugin-qt-x86_64.AppImage
            export QML_SOURCES_PATHS="${{env.QML_DIR}}"
            ./linuxdeploy-x86_64.AppImage --appdir AppDir -e ${{env.UNIXNAME}}-pro -i ../../app/deploy/linux/${{env.UNIXNAME}}-pro.svg -d ../../app/deploy/linux/${{env.UNIXNAME}}-pro.desktop --plugin qt --output appimage
            rm linuxdeploy-x86_64.AppImage
            rm linuxdeploy-plugin-qt-x86_64.AppImage
          else
            wget https://github.com/linuxdeploy/linuxdeploy/releases/download/1-alpha-20240109-1/linuxdeploy-aarch64.AppImage
            wget https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-aarch64.AppImage
            chmod +x linuxdeploy-aarch64.AppImage
            chmod +x linuxdeploy-plugin-qt-aarch64.AppImage
            export QML_SOURCES_PATHS="${{env.QML_DIR}}"
            ./linuxdeploy-aarch64.AppImage --appdir AppDir -e ${{env.UNIXNAME}} -i ../../app/deploy/linux/${{env.UNIXNAME}}.svg -d ../../app/deploy/linux/${{env.UNIXNAME}}.desktop --plugin qt --output appimage
            rm linuxdeploy-aarch64.AppImage
            rm linuxdeploy-plugin-qt-aarch64.AppImage
          fi
          
          mv *.AppImage ../../$APPIMAGE_NAME

      #---------------------------------------------------------------------------
      # Artifact upload
      #---------------------------------------------------------------------------

      - name: "ðŸ“¤ Upload artifact: AppImage"
        uses: actions/upload-artifact@v4
        with:
          name: ${{env.EXECUTABLE}}-${{ matrix.edition == 'commercial' && 'Pro' || 'GPL3' }}-${{env.VERSION}}-Linux-${{matrix.arch}}
          path: ${{env.EXECUTABLE}}-${{ matrix.edition == 'commercial' && 'Pro' || 'GPL3' }}-${{env.VERSION}}-Linux-${{matrix.arch}}.AppImage


#-------------------------------------------------------------------------------
# macOS build (arm64 and x86_64)
#-------------------------------------------------------------------------------

  build-macos:
    runs-on: macos-latest
    name: "ðŸŽ macOS (Universal) - Pro"
    steps:
    - name: "ðŸ§° Checkout"
      uses: actions/checkout@v4

    - name: "âš™ï¸ Restore Qt Cache"
      uses: actions/cache/restore@v3
      if: env.INSTALL_QT_MACOS == 'false'
      with:
        path: |
          ${{github.workspace}}/Qt-${{env.QT_VERSION_MACOS}}-${{runner.os}}-x64
          ${{env.USERPROFILE}}/.qt-license
        key: qt-${{runner.os}}-${{env.QT_VERSION_MACOS}}-x64

    - name: "âš™ï¸ Install Qt"
      shell: bash
      if: env.INSTALL_QT_MACOS == 'true'
      env:
        QT_VERSION: ${{env.QT_VERSION_MACOS}}
        QT_ARCH: x64
        QT_USERNAME: ${{secrets.QT_USERNAME}}
        QT_PASSWORD: ${{secrets.QT_PASSWORD}}
        QT_OUTPUT_DIR: ${{github.workspace}}/Qt-${{env.QT_VERSION_MACOS}}-${{runner.os}}-x64
      run: |
        chmod +x ./scripts/install-qt.sh
        ./scripts/install-qt.sh

    - name: "âš™ï¸ Save Qt Cache"
      if: env.INSTALL_QT_MACOS == 'true'
      uses: actions/cache/save@v3
      with:
        path: |
          ${{github.workspace}}/Qt-${{env.QT_VERSION_MACOS}}-${{runner.os}}-x64
          ${{env.USERPROFILE}}/.qt-license
        key: qt-${{runner.os}}-${{env.QT_VERSION_MACOS}}-x64

    - name: "âš™ï¸ Add Qt to PATH"
      shell: bash
      env:
        QT_VERSION: ${{env.QT_VERSION_MACOS}}
        QT_OUTPUT_DIR: ${{github.workspace}}/Qt-${{env.QT_VERSION_MACOS}}-${{runner.os}}-x64
      run: |
        export QT_BIN_PATH="${QT_OUTPUT_DIR}/${QT_VERSION}/macos/bin"
        export QT_LIBEXEC_PATH="${QT_OUTPUT_DIR}/${QT_VERSION}/macos/libexec"
        export CMAKE_PREFIX_PATH="${QT_OUTPUT_DIR}/${QT_VERSION}/macos/lib/cmake"

        echo "$QT_BIN_PATH" >> $GITHUB_PATH
        echo "$QT_LIBEXEC_PATH" >> $GITHUB_PATH
        echo "CMAKE_PREFIX_PATH=$CMAKE_PREFIX_PATH" >> $GITHUB_ENV

    - name: "âš™ï¸ Install CMake"
      uses: lukka/get-cmake@latest
      with:
        useLocalCache: true

    - name: "âš™ï¸ Install Node"
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: "ðŸš§ Configure with CMake"
      env:
        ARCGIS_API_KEY: ${{secrets.ARCGIS_API_KEY}}
        SERIAL_STUDIO_LICENSE_KEY: ${{secrets.SERIAL_STUDIO_LICENSE_KEY}}
        SERIAL_STUDIO_INSTANCE_ID: ${{secrets.SERIAL_STUDIO_INSTANCE_ID}}
      run: |
        mkdir build
        cd build
        cmake ../ -DPRODUCTION_OPTIMIZATION=ON -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_DEPLOYMENT_TARGET=12.0 -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64" -DBUILD_COMMERCIAL=ON -DBUILD_GPL3=OFF

    - name: "ðŸš§ Build application"
      run: |
        cd build
        cmake --build . --config Release --parallel 16

    - name: "ðŸ“¦ Package application"
      run: |
        cd build
        cpack --verbose

    - name: "ðŸªª Import Certificates"
      uses: alex-spataru/import-codesign-certs@v4
      with:
        p12-file-base64: ${{secrets.APPLE_CERTIFICATES_P12}}
        p12-password: ${{secrets.APPLE_CERTIFICATES_P12_PASSWORD}}

    - name: "ðŸ’¿ Mount DMG and copy application"
      run: |
        VOLUME=$(yes | hdiutil attach ./build/*.dmg -nobrowse | grep "Volumes" | awk '{print $3}')
        cp -a "$VOLUME/${{env.EXECUTABLE}}.app" "${{env.APPLICATION}} Pro.app"
        hdiutil detach "$VOLUME"

    - name: "âœðŸ» Sign Application with Entitlements"
      run: |
        codesign --force --deep --options runtime \
          --entitlements "${GITHUB_WORKSPACE}/app/deploy/macOS/Serial-Studio.entitlements" \
          --sign "${{secrets.APPLE_APPID_TEAM_ID}}" \
          "${{env.APPLICATION}} Pro.app"

    - name: "ðŸ’½ Create nice DMG"
      run: |
        npm install --global create-dmg
        rm LICENSE.md
        create-dmg "${{env.APPLICATION}} Pro.app" --dmg-title="${{env.APPLICATION}} Pro"
        mv "${{env.APPLICATION}} ${{env.VERSION}}.dmg" "${{env.EXECUTABLE}}-Pro-${{env.VERSION}}-macOS.dmg"

    - name: "ðŸ“‹ Notarize"
      shell: bash
      env:
        PRODUCT_PATH: ${{env.EXECUTABLE}}-Pro-${{env.VERSION}}-macOS.dmg
        APPLE_ID: ${{secrets.APPLE_NOTARIZATION_USERNAME}}
        APP_PASSWORD: ${{secrets.APPLE_NOTARIZATION_PASSWORD}}
        TEAM_ID: ${{secrets.APPLE_NOTARIZATION_TEAMID}}
      run: |
        echo "Submitting $PRODUCT_PATH for notarization..."
        xcrun notarytool submit "$PRODUCT_PATH" \
          --apple-id "$APPLE_ID" \
          --password "$APP_PASSWORD" \
          --team-id "$TEAM_ID" \
          --wait \
          --output-format json

    - name: "ðŸ“Œ Staple"
      shell: bash
      run: |
        PRODUCT="${{env.EXECUTABLE}}-Pro-${{env.VERSION}}-macOS.dmg"
        echo "Stapling $PRODUCT..."
        xcrun stapler staple "$PRODUCT"

    - name: "ðŸ“¤ Upload artifact: DMG"
      uses: actions/upload-artifact@v4
      with:
        name: ${{env.EXECUTABLE}}-Pro-${{env.VERSION}}-macOS.dmg
        path: ${{env.EXECUTABLE}}-Pro-${{env.VERSION}}-macOS.dmg

#-------------------------------------------------------------------------------
# Windows build (MinGW x86_64)
#-------------------------------------------------------------------------------
  
  build-windows:
    runs-on: windows-latest
    name: "ðŸ§Š Windows (x64) - Pro"
    steps:
    - run: git config --global core.autocrlf input
  
    - name: "ðŸ§° Checkout"
      uses: actions/checkout@v4
  
    - name: "âš™ï¸ Restore Qt Cache"
      uses: actions/cache/restore@v3
      if: env.INSTALL_QT_WINDOWS == 'false'
      with:
        path: |
          ${{github.workspace}}/Qt-${{env.QT_VERSION_WINDOWS}}-${{runner.os}}-x64
          ${{env.USERPROFILE}}/.qt-license
        key: qt-${{runner.os}}-${{env.QT_VERSION_WINDOWS}}-x64-mingw_64
  
    - name: "âš™ï¸ Install Qt (MinGW)"
      shell: pwsh
      if: env.INSTALL_QT_WINDOWS == 'true'
      env:
        QT_VERSION: ${{env.QT_VERSION_WINDOWS}}
        QT_ARCH: x64
        QT_USERNAME: ${{secrets.QT_USERNAME}}
        QT_PASSWORD: ${{secrets.QT_PASSWORD}}
        QT_OUTPUT_DIR: ${{github.workspace}}/Qt-${{env.QT_VERSION_WINDOWS}}-${{runner.os}}-x64
      run: |
        ./scripts/install-qt.ps1
  
    - name: "âš™ï¸ Save Qt Cache"
      if: env.INSTALL_QT_WINDOWS == 'true'
      uses: actions/cache/save@v3
      with:
        path: |
          ${{github.workspace}}/Qt-${{env.QT_VERSION_WINDOWS}}-${{runner.os}}-x64
          ${{env.USERPROFILE}}/.qt-license
        key: qt-${{runner.os}}-${{env.QT_VERSION_WINDOWS}}-x64-mingw_64
  
    - name: "âš™ï¸ Add Qt to PATH"
      shell: pwsh
      env:
        QT_VERSION: ${{env.QT_VERSION_WINDOWS}}
        QT_OUTPUT_DIR: ${{github.workspace}}/Qt-${{env.QT_VERSION_WINDOWS}}-${{runner.os}}-x64
      run: |
        $QT_BIN_PATH = "$env:QT_OUTPUT_DIR\$env:QT_VERSION\mingw_64\bin"
        $QT_LIBEXEC_PATH = "$env:QT_OUTPUT_DIR\$env:QT_VERSION\mingw_64\libexec"
        $CMAKE_PREFIX_PATH = "$env:QT_OUTPUT_DIR\$env:QT_VERSION\mingw_64\lib\cmake"
  
        Write-Output "$QT_BIN_PATH" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        Write-Output "$QT_LIBEXEC_PATH" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        Write-Output "CMAKE_PREFIX_PATH=$CMAKE_PREFIX_PATH" >> $env:GITHUB_ENV

    - name: "âš™ï¸ Install CMake"
      uses: lukka/get-cmake@latest
      with:
        useLocalCache: true
  
    - name: "ðŸš§ Configure with CMake (MinGW)"
      env:
        ARCGIS_API_KEY: ${{secrets.ARCGIS_API_KEY}}
        SERIAL_STUDIO_LICENSE_KEY: ${{secrets.SERIAL_STUDIO_LICENSE_KEY}}
        SERIAL_STUDIO_INSTANCE_ID: ${{secrets.SERIAL_STUDIO_INSTANCE_ID}}
        QT_BIN_PATH: ${{github.workspace}}/Qt-${{env.QT_VERSION_WINDOWS}}-${{runner.os}}-x64/${{env.QT_VERSION_WINDOWS}}/mingw_64/bin
        QT_TOOLS_PATH: ${{github.workspace}}/Qt-${{env.QT_VERSION_WINDOWS}}-${{runner.os}}-x64/Tools/mingw1310_64/bin
      run: |
        $env:PATH = "$env:QT_BIN_PATH;$env:PATH"
        mkdir build
        cd build
        cmake ../ `
          -G "MinGW Makefiles" `
          -DCMAKE_C_COMPILER="${env:QT_TOOLS_PATH}\\gcc.exe" `
          -DCMAKE_CXX_COMPILER="${env:QT_TOOLS_PATH}\\c++.exe" `
          -DPRODUCTION_OPTIMIZATION=ON `
          -DCMAKE_BUILD_TYPE=Release `
          -DBUILD_COMMERCIAL=ON `
          -DBUILD_GPL3=OFF
  
    - name: "ðŸš§ Build application"
      env:
        QT_BIN_PATH: ${{github.workspace}}/Qt-${{env.QT_VERSION_WINDOWS}}-${{runner.os}}-x64/${{env.QT_VERSION_WINDOWS}}/mingw_64/bin
      run: |
        $env:PATH = "$env:QT_BIN_PATH;$env:PATH"
        cd build
        cmake --build . --config Release --parallel 16
  
    - name: "âš™ï¸ Install WiX"
      run: dotnet tool install --global wix
  
    - name: "ðŸ“¦ Package application"
      env:
        QT_BIN_PATH: ${{github.workspace}}/Qt-${{env.QT_VERSION_WINDOWS}}-${{runner.os}}-x64/${{env.QT_VERSION_WINDOWS}}/mingw_64/bin
      run: |
        $env:PATH = "$env:QT_BIN_PATH;$env:PATH"
        cd build
        cpack --verbose
        mv *.msi ${{env.EXECUTABLE}}-Pro-${{env.VERSION}}-Windows.msi
        mv ${{env.EXECUTABLE}}-Pro-${{env.VERSION}}-Windows.msi ../
  
    - name: "ðŸ“¤ Upload artifact: MSI installer"
      uses: actions/upload-artifact@v4
      with:
        name: ${{env.EXECUTABLE}}-Pro-${{env.VERSION}}-Windows.msi
        path: ${{env.EXECUTABLE}}-Pro-${{env.VERSION}}-Windows.msi

#-------------------------------------------------------------------------------
# Create release
#-------------------------------------------------------------------------------

  upload:
    name: "ðŸ—‚ Create release and upload artifacts"
    needs:
      - build-macos
      - build-linux
      - build-windows

    runs-on: ubuntu-latest
    env:
      RELEASE_TAG: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') && github.ref_name || 'continuous' }}

    steps:
      - name: 'ðŸ“¥ Download artifacts'
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          merge-multiple: true

      - name: "ðŸ—‘ï¸ Delete previous release and tag if exists"
        run: |
          if gh release view "$RELEASE_TAG" --repo "$GITHUB_REPOSITORY" &>/dev/null; then
            echo "Release '$RELEASE_TAG' exists. Deleting..."
            gh release delete "$RELEASE_TAG" --cleanup-tag --yes --repo "$GITHUB_REPOSITORY" || echo "Failed to delete release. Ignoring."
          else
            echo "No release named '$RELEASE_TAG' found. Skipping delete."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: "ðŸ” Generate SHA256 checksums with sizes"
        run: |
          echo "| File | SHA256 Checksum |" > release-body.md
          echo "|------|-----------------|" >> release-body.md

          find ./artifacts -type f \( -name "*.deb" -o -name "*.rpm" -o -name "*.AppImage" -o -name "*.dmg" -o -name "*.exe" -o -name "*.msi" \) | sort | while read -r file; do
            hash=$(sha256sum "$file" | awk '{print $1}')
            filename=$(basename "$file")
            echo "| \`$filename\` | \`$hash\` |" >> release-body.md
          done

      - name: "ðŸš€ Create Release"
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ env.RELEASE_TAG }}
          prerelease: true
          allowUpdates: true
          replacesArtifacts: true
          name: 'Continuous Build'
          bodyFile: release-body.md
          artifacts: |
            artifacts/*.AppImage
            artifacts/*.dmg
            artifacts/*.msi
