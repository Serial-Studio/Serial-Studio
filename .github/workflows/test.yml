#
# Serial Studio
# https://serial-studio.com/
#
# Copyright (C) 2020â€“2025 Alex Spataru
#
# This file is dual-licensed:
#
# - Under the GNU GPLv3 (or later) for builds that exclude Pro modules.
# - Under the Serial Studio Commercial License for builds that include
#   any Pro functionality.
#
# You must comply with the terms of one of these licenses, depending
# on your use case.
#
# For GPL terms, see <https://www.gnu.org/licenses/gpl-3.0.html>
# For commercial terms, see LICENSE_COMMERCIAL.md in the project root.
#
# SPDX-License-Identifier: GPL-3.0-only OR LicenseRef-SerialStudio-Commercial
#

name: Unit Tests

on:
  push:
    branches: [master, develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [master, develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'

env:
  QT_VERSION: 6.9.2
  CMAKE_BUILD_TYPE: Debug

jobs:
  test-linux:
    runs-on: ubuntu-22.04
    name: ðŸ§ª Linux Unit Tests

    steps:
      - name: ðŸ§° Checkout
        uses: actions/checkout@v4

      - name: âš™ï¸ Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libgl1-mesa-dev \
            libxkbcommon-x11-0 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-randr0 \
            libxcb-render-util0 \
            libxcb-xinerama0 \
            libxcb-xfixes0 \
            libxcb-cursor0 \
            xvfb

      - name: ðŸ“¦ Install Qt ${{ env.QT_VERSION }}
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          modules: 'qt5compat qtserialport qtconnectivity qtquick3d qtgraphs'
          cache: true

      - name: ðŸ”¨ Configure CMake
        run: |
          mkdir build
          cd build
          cmake ../ \
            -DBUILD_TESTS=ON \
            -DBUILD_GPL3=ON \
            -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }}

      - name: ðŸ—ï¸ Build Tests
        run: |
          cd build
          cmake --build . -j$(nproc)

      - name: ðŸ§ª Run Tests
        run: |
          cd build
          xvfb-run -a ctest --output-on-failure --verbose

      - name: ðŸ“Š Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-linux
          path: |
            build/Testing/Temporary/LastTest.log
            build/tests/

      - name: ðŸ“ˆ Test Summary
        if: always()
        run: |
          cd build
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          if [ -f Testing/Temporary/LastTest.log ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -n 50 Testing/Temporary/LastTest.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
